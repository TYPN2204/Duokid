<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>H·ªôp h·ªôi tho·∫°i - Kid Nani</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <script src="/grade-dropdown.js" defer></script>
    <style>
        .chat-container {
            display: flex;
            height: calc(100vh - 180px); /* Adjusted for top nav bar (64px) + header + margins */
            gap: 20px;
            margin-top: 20px;
        }
        .users-list {
            width: 300px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .users-list h3 {
            margin: 0 0 15px 0;
            color: #1F2937;
            font-size: 18px;
        }
        .user-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-item:hover {
            background: #F3F4F6;
        }
        .user-item.active {
            background: #E0F2FE;
            border: 2px solid #3B82F6;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }
        .user-info {
            flex: 1;
        }
        .user-name {
            font-weight: 600;
            color: #1F2937;
            font-size: 14px;
        }
        .user-email {
            font-size: 12px;
            color: #6B7280;
        }
        .unread-badge {
            background: #EF4444;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-header {
            padding: 20px;
            border-bottom: 2px solid #E5E7EB;
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            color: white;
        }
        .chat-header h2 {
            margin: 0;
            font-size: 20px;
        }
        .chat-header p {
            margin: 4px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
        }
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #F9FAFB;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .message.sent {
            align-items: flex-end;
        }
        .message.received {
            align-items: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .message.sent .message-bubble {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received .message-bubble {
            background: white;
            color: #1F2937;
            border: 2px solid #E5E7EB;
            border-bottom-left-radius: 4px;
        }
        .message-time {
            font-size: 11px;
            color: #9CA3AF;
            margin-top: 4px;
            padding: 0 8px;
        }
        .message-input-area {
            padding: 20px;
            border-top: 2px solid #E5E7EB;
            background: white;
        }
        .message-form {
            width: 100%;
        }
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
        }
        .message-input:focus {
            border-color: #3B82F6;
        }
        .emoji-btn, .image-btn {
            padding: 12px 16px;
            background: #F3F4F6;
            color: #1F2937;
            border: 2px solid #E5E7EB;
            border-radius: 24px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .emoji-btn:hover, .image-btn:hover {
            background: #E5E7EB;
            transform: scale(1.05);
        }
        .send-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            color: white;
            border: none;
            border-radius: 24px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .send-btn:hover {
            transform: scale(1.05);
        }
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .message-input-area {
            position: relative;
        }
        .no-chat-selected {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9CA3AF;
            font-size: 16px;
        }
        .select-user-hint {
            text-align: center;
            padding: 40px;
        }
        .select-user-hint .icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
<div class="layout">
    <header class="top-nav">
        <div class="logo">duokid</div>
        <nav>
            <a th:href="@{/dashboard}">üè† H·ªåC</a>
            <span class="menu-divider"></span>
            <div class="grade-dropdown">
                <span class="grade-dropdown-trigger">üìö L·ªõp h·ªçc</span>
                <div class="grade-dropdown-menu">
                    <a th:href="@{/grade/GRADE1}">L·ªõp 1</a>
                    <a th:href="@{/grade/GRADE2}">L·ªõp 2</a>
                    <a th:href="@{/grade/GRADE3}">L·ªõp 3</a>
                    <a th:href="@{/grade/GRADE4}">L·ªõp 4</a>
                    <a th:href="@{/grade/GRADE5}">L·ªõp 5</a>
                </div>
            </div>
            <span class="menu-divider"></span>
            <a th:href="@{/mywords}">üìù S·ªï tay</a>
            <a th:href="@{/vocabulary}">üìö T·ª´ v·ª±ng</a>
            <a th:href="@{/practice}">üîÑ √în t·∫≠p</a>
            <a th:href="@{/minigame}">üéÆ Mini game</a>
            <a th:href="@{/tests}">üìù B√†i ki·ªÉm tra</a>
            <a th:href="@{/leaderboard}">üèÜ B·∫£ng x·∫øp h·∫°ng</a>
            <a th:href="@{/shop}">üõí C·ª≠a h√†ng</a>
            <a th:href="@{/chat}" class="active">üí¨ Chat</a>
            <a th:href="@{/profile}">üë§ H·ªì s∆°</a>
            <a th:if="${isAdmin}" th:href="@{/admin}" style="background: #FEF3C7; color: #92400E;">
                üëë Qu·∫£n tr·ªã
            </a>
            <span class="menu-divider"></span>
            <a th:href="@{/logout}">üö™ ƒêƒÉng xu·∫•t</a>
        </nav>
    </header>

    <main class="main" style="margin-right: 0;">
        <div style="margin-bottom: 20px;">
            <h1>üí¨ H·ªôp h·ªôi tho·∫°i</h1>
            <p>Tr√≤ chuy·ªán v√† trao ƒë·ªïi b√†i v·ªõi c√°c b·∫°n h·ªçc sinh kh√°c</p>
        </div>

        <div class="chat-container">
            <!-- Danh s√°ch ng∆∞·ªùi d√πng -->
            <div class="users-list">
                <h3>üë• Danh s√°ch h·ªçc sinh</h3>
                
                <!-- Ng∆∞·ªùi ƒë√£ chat -->
                <div th:if="${chatPartners != null && !chatPartners.isEmpty()}">
                    <p style="font-size: 12px; color: #6B7280; margin: 10px 0 8px 0; font-weight: 600;">ƒê√£ tr√≤ chuy·ªán</p>
                    <div th:each="partner : ${chatPartners}">
                        <a th:href="@{/chat(withUserId=${partner.id})}" 
                           class="user-item" 
                           style="text-decoration: none; display: block;"
                           th:classappend="${partner != null && partner.id == (partner?.id ?: 0) ? 'active' : ''}">
                            <div class="user-avatar" th:text="${partner.displayName != null ? partner.displayName.substring(0, 1).toUpperCase() : '?'}"></div>
                            <div class="user-info">
                                <div class="user-name" th:text="${partner.displayName}">T√™n ng∆∞·ªùi d√πng</div>
                                <div class="user-email" th:text="${partner.email}">email@example.com</div>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- T·∫•t c·∫£ ng∆∞·ªùi d√πng -->
                <div th:if="${allUsers != null && !allUsers.isEmpty()}">
                    <p style="font-size: 12px; color: #6B7280; margin: 15px 0 8px 0; font-weight: 600;">T·∫•t c·∫£ h·ªçc sinh</p>
                    <div th:each="user : ${allUsers}">
                        <a th:href="@{/chat(withUserId=${user.id})}" 
                           class="user-item" 
                           style="text-decoration: none; display: block;"
                           th:classappend="${partner != null && user.id == (partner?.id ?: 0) ? 'active' : ''}">
                            <div class="user-avatar" th:text="${user.displayName != null ? user.displayName.substring(0, 1).toUpperCase() : '?'}"></div>
                            <div class="user-info">
                                <div class="user-name" th:text="${user.displayName}">T√™n ng∆∞·ªùi d√πng</div>
                                <div class="user-email" th:text="${user.email}">email@example.com</div>
                            </div>
                        </a>
                    </div>
                </div>

                <div th:if="${(chatPartners == null || chatPartners.isEmpty()) && (allUsers == null || allUsers.isEmpty())}" 
                     style="text-align: center; padding: 40px 20px; color: #9CA3AF;">
                    <p>Ch∆∞a c√≥ h·ªçc sinh n√†o</p>
                </div>
            </div>

            <!-- Khu v·ª±c chat -->
            <div class="chat-area">
                <div th:if="${partner == null}" class="no-chat-selected">
                    <div class="select-user-hint">
                        <div class="icon">üí¨</div>
                        <p>Ch·ªçn m·ªôt h·ªçc sinh ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</p>
                    </div>
                </div>

                <div th:if="${partner != null}">
                    <!-- Error/Success messages -->
                    <div th:if="${error}" style="padding: 12px 20px; margin: 10px 20px; background: #FEE2E2; border: 2px solid #EF4444; border-radius: 8px; color: #991B1B;">
                        <strong>‚ùå</strong> <span th:text="${error}"></span>
                    </div>
                    <div th:if="${success}" style="padding: 12px 20px; margin: 10px 20px; background: #D1FAE5; border: 2px solid #10B981; border-radius: 8px; color: #065F46;">
                        <strong>‚úÖ</strong> <span th:text="${success}"></span>
                    </div>
                    
                    <!-- Header -->
                    <div class="chat-header">
                        <h2 th:text="${partner.displayName}">T√™n ng∆∞·ªùi d√πng</h2>
                        <p th:text="${partner.email}">email@example.com</p>
                    </div>

                    <!-- Messages -->
                    <div class="messages-container" id="messagesContainer">
                        <div th:if="${messages != null && !messages.isEmpty()}">
                            <div th:each="message : ${messages}" 
                                 class="message"
                                 th:classappend="${message != null && message.sender != null && message.sender.id == user.id ? 'sent' : 'received'}">
                                <div class="message-bubble">
                                    <!-- Hi·ªÉn th·ªã ·∫£nh n·∫øu c√≥ -->
                                    <div th:if="${message != null && message.imageUrl != null && !message.imageUrl.isEmpty()}" style="margin-bottom: 8px;">
                                        <img th:src="@{${message.imageUrl}}" 
                                             style="max-width: 300px; max-height: 300px; border-radius: 12px; cursor: pointer;"
                                             onclick="window.open(this.src, '_blank')"
                                             alt="·∫¢nh ƒë√≠nh k√®m">
                                    </div>
                                    <!-- Hi·ªÉn th·ªã n·ªôi dung n·∫øu c√≥ -->
                                    <div th:if="${message != null && message.content != null && !message.content.isEmpty()}" 
                                         th:utext="${#strings.replace(#strings.replace(message.content, '&lt;', '&amp;lt;'), '&gt;', '&amp;gt;')}">Tin nh·∫Øn</div>
                                </div>
                                <div class="message-time" 
                                     th:if="${message != null && message.sentAt != null}"
                                     th:text="${#temporals.format(message.sentAt, 'HH:mm, dd/MM/yyyy')}">Th·ªùi gian</div>
                            </div>
                        </div>
                        <div th:if="${messages == null || messages.isEmpty()}" 
                             style="text-align: center; padding: 40px; color: #9CA3AF;">
                            <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o. H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán!</p>
                        </div>
                    </div>

                    <!-- Input -->
                    <div class="message-input-area">
                        <!-- Image preview -->
                        <div id="imagePreview" style="display: none; margin-bottom: 8px; padding: 8px; background: #F9FAFB; border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <img id="previewImg" style="max-width: 150px; max-height: 150px; border-radius: 8px; border: 2px solid #E5E7EB;">
                                <button type="button" onclick="removeImagePreview()" style="padding: 6px 12px; background: #EF4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">‚úï X√≥a</button>
                            </div>
                        </div>
                        
                        <form th:action="@{/chat/send}" method="post" enctype="multipart/form-data" class="message-form" id="messageForm">
                            <input type="hidden" name="receiverId" th:value="${partner.id}">
                            
                            <!-- File input (hidden) -->
                            <input type="file" 
                                   name="image" 
                                   id="imageInput" 
                                   accept="image/*" 
                                   style="display: none;"
                                   onchange="handleImageSelect(event)">
                            
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <!-- Emoji picker button -->
                                <button type="button" class="emoji-btn" id="emojiBtn" title="Ch·ªçn emoji">üòä</button>
                                
                                <input type="text" 
                                       name="content" 
                                       class="message-input" 
                                       placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..."
                                       autocomplete="off"
                                       id="messageInput">
                                
                                <!-- Image upload button -->
                                <button type="button" class="image-btn" id="imageBtn" title="G·ª≠i ·∫£nh">üì∑</button>
                                
                                <button type="submit" class="send-btn">G·ª≠i</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Emoji picker popup -->
                    <div id="emojiPicker" style="display: none; position: absolute; bottom: 80px; background: white; border: 2px solid #E5E7EB; border-radius: 12px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-width: 300px; max-height: 250px; overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;" id="emojiGrid">
                            <!-- Emojis will be inserted by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // Function kh√¥ng c·∫ßn thi·∫øt n·ªØa v√¨ ƒë√£ d√πng link tr·ª±c ti·∫øp

    // Auto-scroll to bottom when new messages arrive
    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }

    // Auto-refresh messages every 3 seconds
    let currentPartnerId = null;
    <span th:if="${partner != null}">
    currentPartnerId = <span th:text="${partner.id}">0</span>;
    </span>

    if (currentPartnerId) {
        setInterval(function() {
            fetch('/chat/api/messages?withUserId=' + currentPartnerId)
                .then(response => response.json())
                .then(data => {
                    // Reload page to show new messages
                    // In production, you might want to update DOM directly
                    const messageCount = document.querySelectorAll('.message').length;
                    if (data.length > messageCount) {
                        location.reload();
                    }
                })
                .catch(err => console.error('Error fetching messages:', err));
        }, 3000);
    }

    // Scroll to bottom on page load
    window.addEventListener('load', function() {
        scrollToBottom();
    });

    // Scroll to bottom when form is submitted
    document.getElementById('messageForm')?.addEventListener('submit', function() {
        setTimeout(scrollToBottom, 100);
    });

    // Enter key to send
    const messageInputEl = document.getElementById('messageInput');
    if (messageInputEl) {
        messageInputEl.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const form = document.getElementById('messageForm');
                const input = document.getElementById('messageInput');
                const imageInput = document.getElementById('imageInput');
                const hasText = input && input.value && input.value.trim().length > 0;
                const hasImage = imageInput && imageInput.files && imageInput.files.length > 0;
                if (hasText || hasImage) {
                    form?.submit();
                } else {
                    alert('Vui l√≤ng nh·∫≠p tin nh·∫Øn ho·∫∑c ch·ªçn ·∫£nh!');
                }
            }
        });
    }

    // Common emojis
    const commonEmojis = [
        "üòä", "üòÉ", "üòÑ", "üòÅ", "üòÜ", "üòÖ", "üòÇ", "ü§£",
        "üòç", "ü•∞", "üòò", "üòó", "üòô", "üòö", "üòã", "üòõ",
        "üòú", "üòù", "üòé", "ü§ì", "üßê", "ü§ó", "ü§î", "ü§≠",
        "üëç", "üëé", "üëå", "‚úåÔ∏è", "ü§û", "ü§ü", "ü§ò", "üëè",
        "üôå", "üëê", "ü§≤", "üôè", "üí™", "ü¶æ", "ü¶ø", "ü¶µ",
        "‚ù§Ô∏è", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç",
        "‚≠ê", "üåü", "‚ú®", "üí´", "üí•", "üî•", "üíØ", "üéâ",
        "üéä", "üéà", "üéÅ", "üèÜ", "ü•á", "ü•à", "ü•â", "üèÖ"
    ];

    // Initialize emoji picker
    const emojiGrid = document.getElementById('emojiGrid');
    if (emojiGrid) {
        commonEmojis.forEach(emoji => {
            const span = document.createElement('span');
            span.textContent = emoji;
            span.style.cssText = 'font-size: 24px; cursor: pointer; padding: 4px; text-align: center; border-radius: 6px; transition: background 0.2s;';
            span.addEventListener('mouseenter', function() {
                this.style.background = '#F3F4F6';
            });
            span.addEventListener('mouseleave', function() {
                this.style.background = 'transparent';
            });
            span.addEventListener('click', function() {
                insertEmoji(emoji);
            });
            emojiGrid.appendChild(span);
        });
    }

    // Emoji picker
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const messageInput = document.getElementById('messageInput');
    
    emojiBtn?.addEventListener('click', function(e) {
        e.stopPropagation();
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
    });
    
    // Close emoji picker when clicking outside
    document.addEventListener('click', function(e) {
        if (emojiPicker && !emojiPicker.contains(e.target) && e.target !== emojiBtn) {
            emojiPicker.style.display = 'none';
        }
    });
    
    // Insert emoji function
    window.insertEmoji = function(emoji) {
        if (messageInput) {
            messageInput.value += emoji;
            messageInput.focus();
            emojiPicker.style.display = 'none';
        }
    };

    // Image upload button
    document.getElementById('imageBtn')?.addEventListener('click', function() {
        document.getElementById('imageInput')?.click();
    });

    // Handle image selection
    window.handleImageSelect = function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                if (preview && previewImg) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                }
            };
            reader.readAsDataURL(file);
        }
    };

    // Remove image preview
    window.removeImagePreview = function() {
        const preview = document.getElementById('imagePreview');
        const imageInput = document.getElementById('imageInput');
        if (preview) preview.style.display = 'none';
        if (imageInput) imageInput.value = '';
    };

    // Form validation - ch·ªâ validate, kh√¥ng ch·∫∑n n·∫øu c√≥ √≠t nh·∫•t m·ªôt trong hai
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            const input = document.getElementById('messageInput');
            const imageInput = document.getElementById('imageInput');
            const hasText = input && input.value && input.value.trim().length > 0;
            const hasImage = imageInput && imageInput.files && imageInput.files.length > 0;
            
            if (!hasText && !hasImage) {
                e.preventDefault();
                alert('Vui l√≤ng nh·∫≠p tin nh·∫Øn ho·∫∑c ch·ªçn ·∫£nh!');
                return false;
            }
            // Cho ph√©p submit n·∫øu c√≥ √≠t nh·∫•t text ho·∫∑c image
        });
    }
</script>
</body>
</html>

