<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${lesson.title}">BÃ i há»c</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <script src="/grade-dropdown.js" defer></script>
</head>
<body>
<div class="layout">
    <header class="top-nav">
        <div class="logo">duokid</div>
        <nav>
            <a th:href="@{/dashboard}">ğŸ  Há»ŒC</a>
            <span class="menu-divider"></span>
            <div class="grade-dropdown">
                <span class="grade-dropdown-trigger">ğŸ“š Lá»›p há»c</span>
                <div class="grade-dropdown-menu">
                    <a th:href="@{/grade/GRADE1}">Lá»›p 1</a>
                    <a th:href="@{/grade/GRADE2}">Lá»›p 2</a>
                    <a th:href="@{/grade/GRADE3}">Lá»›p 3</a>
                    <a th:href="@{/grade/GRADE4}">Lá»›p 4</a>
                    <a th:href="@{/grade/GRADE5}">Lá»›p 5</a>
                </div>
            </div>
            <span class="menu-divider"></span>
            <a th:href="@{/mywords}">ğŸ“ Sá»• tay</a>
            <a th:href="@{/vocabulary}">ğŸ“š Tá»« vá»±ng</a>
            <a th:href="@{/practice}">ğŸ”„ Ã”n táº­p</a>
            <a th:href="@{/minigame}">ğŸ® Mini game</a>
            <a th:href="@{/leaderboard}">ğŸ† Báº£ng xáº¿p háº¡ng</a>
            <a th:href="@{/shop}">ğŸ›’ Cá»­a hÃ ng</a>
            <a th:href="@{/chat}">ğŸ’¬ Chat</a>
            <a th:href="@{/profile}">ğŸ‘¤ Há»“ sÆ¡</a>
            <span class="menu-divider"></span>
            <a th:href="@{/logout}">ğŸšª ÄÄƒng xuáº¥t</a>
        </nav>
    </header>
    <main class="main">
        <div class="lesson-header">
            <h1 th:text="${lesson.title}">Lesson</h1>
            <div class="pill">ThÆ°á»Ÿng <span th:text="${lesson.xpReward}">10</span> XP</div>
        </div>
        <p th:text="${lesson.description}">MÃ´ táº£</p>
        
        <!-- Vocabulary Cards Display -->
        <div class="vocab-cards-container" id="vocabCardsContainer">
            <!-- Vocabulary cards will be generated by JavaScript from lesson content -->
        </div>
        
        <div class="lesson-content hidden" th:utext="${lesson.contentHtml}"></div>

        <div th:if="${message}" class="success" style="margin: 20px 0; padding: 12px; background: #D1FAE5; color: #065F46; border-radius: 8px; border: 1px solid #10B981;">
            <strong>âœ“</strong> <span th:text="${message}"></span>
        </div>

        <!-- Warning message if no quiz -->
        <div th:if="${!hasQuiz && !isCompleted}" style="background: #FEF3C7; border: 2px solid #F59E0B; border-radius: 8px; padding: 15px; margin: 20px 0;">
            <p style="margin: 0; color: #92400E;">
                <strong>âš ï¸ LÆ°u Ã½:</strong> BÃ i há»c nÃ y chÆ°a cÃ³ mini test. Vui lÃ²ng liÃªn há»‡ admin Ä‘á»ƒ thÃªm cÃ¢u há»i quiz.
            </p>
        </div>

        <!-- Requirement message -->
        <div th:if="${hasQuiz && !isCompleted}" style="background: #EFF6FF; border: 2px solid #3B82F6; border-radius: 8px; padding: 15px; margin: 20px 0;">
            <p style="margin: 0; color: #1E40AF;">
                <strong>ğŸ“ YÃªu cáº§u vÆ°á»£t áº£i:</strong> Báº¡n pháº£i lÃ m mini test vÃ  <strong>tráº£ lá»i Ä‘Ãºng háº¿t 100% cÃ¡c cÃ¢u</strong> má»›i Ä‘Æ°á»£c má»Ÿ khÃ³a bÃ i há»c tiáº¿p theo!
            </p>
        </div>

        <div style="display: flex; gap: 12px; margin: 20px 0; flex-wrap: wrap;">
            <!-- Button lÃ m quiz - chá»‰ hiá»ƒn thá»‹ náº¿u cÃ³ quiz vÃ  chÆ°a completed -->
            <form method="get" th:action="@{'/quiz/' + ${lesson.id}}" th:if="${hasQuiz && !isCompleted}">
                <button type="submit" class="btn-main big" style="background: #3B82F6; border-color: #3B82F6;">
                    ğŸ“ LÃ m Mini Test (Báº¯t buá»™c)
                </button>
            </form>
            
            <!-- Button complete chá»‰ dÃ nh cho admin -->
            <form method="post" th:action="@{'/lessons/' + ${lesson.id} + '/complete'}" 
                  th:if="${!isCompleted && isAdmin}" 
                  style="border-left: 2px solid #E5E7EB; padding-left: 12px;">
                <button type="submit" class="btn-main big" style="background: #F59E0B; border-color: #F59E0B;">
                    âš™ï¸ HoÃ n thÃ nh (Admin only)
                </button>
            </form>
            
            <!-- Completed badge -->
            <div th:if="${isCompleted}" style="padding: 12px 24px; background: #D1FAE5; color: #065F46; border-radius: 8px; border: 2px solid #10B981; display: inline-flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">âœ…</span>
                <strong>ÄÃ£ vÆ°á»£t áº£i! BÃ i há»c tiáº¿p theo Ä‘Ã£ Ä‘Æ°á»£c má»Ÿ khÃ³a.</strong>
            </div>
        </div>

        <div class="panel ai-panel">
            <h3>AI gá»£i Ã½ cÃ¢u tiáº¿ng Anh</h3>
            <p>Nháº­p 1 cÃ¢u tiáº¿ng Viá»‡t (liÃªn quan Ä‘áº¿n chá»§ Ä‘á» bÃ i há»c), há»‡ thá»‘ng sáº½ gá»£i Ã½ 1 cÃ¢u tiáº¿ng Anh Ä‘Æ¡n giáº£n.</p>
            <form th:action="@{'/lessons/' + ${lesson.id} + '/suggest'}"
                  method="post"
                  class="ai-form">
                <textarea name="vnText"
                          rows="2"
                          placeholder="VÃ­ dá»¥: Em thÃ­ch con mÃ¨o mÃ u tráº¯ng."
                          th:text="${vnText}"> </textarea>
                <button type="submit" class="btn-main">Gá»£i Ã½ cÃ¢u tiáº¿ng Anh</button>
            </form>
            <p class="error" th:if="${aiError}" th:text="${aiError}"></p>
            <div th:if="${aiSuggestion}" class="ai-result-block">
                <p><strong>CÃ¢u gá»£i Ã½:</strong></p>
                <p class="ai-result">
                    <span th:text="${aiSuggestion}"></span>
                    <button class="tts-btn"
                            th:if="${aiAudioUrl}"
                            type="button"
                            th:data-audio-url="${aiAudioUrl}"
                            onclick="playAudioFromButton(this)">
                        ğŸ”Š Nghe
                    </button>
                </p>
            </div>
        </div>

        <div class="panel">
            <h3>ThÃªm tá»« vá»±ng cá»§a em</h3>
            <form class="myword-form"
                  th:action="@{'/lessons/' + ${lesson.id} + '/mywords'}"
                  method="post">
                <label>
                    Tá»« tiáº¿ng Anh *
                    <input id="lessonWordEn"
                           type="text"
                           name="englishWord"
                           th:value="${wordEnglish}"
                           required>
                </label>
                <label>
                    NghÄ©a tiáº¿ng Viá»‡t *
                    <input id="lessonWordVi"
                           type="text"
                           name="vietnameseMeaning"
                           th:value="${wordVietnamese}"
                           required>
                </label>
                <label>
                    PhiÃªn Ã¢m (IPA)
                    <input id="lessonWordIpa"
                           type="text"
                           name="ipa"
                           th:value="${wordIpa}">
                </label>
                <label>
                    CÃ¢u vÃ­ dá»¥
                    <input id="lessonWordExample"
                           type="text"
                           name="exampleSentence"
                           th:value="${wordExample}">
                </label>
                <button type="submit" class="btn-main">LÆ°u ngay</button>
            </form>
            <p class="error" th:if="${wordError}" th:text="${wordError}"></p>
            <p class="success" th:if="${wordSuccess}" th:text="${wordSuccess}"></p>
            <p class="myword-empty">
                Sau khi lÆ°u, em cÃ³ thá»ƒ xem táº¥t cáº£ á»Ÿ <a th:href="@{/mywords}">Sá»• tay tá»« vá»±ng</a>.
            </p>
        </div>
    </main>
<div id="vocabModal" class="vocab-modal hidden">
    <div class="vocab-modal-inner">
        <div class="vocab-modal-header">
            <h3 id="vm-word">Vocabulary</h3>
            <button id="vm-close" class="vm-close">âœ•</button>
        </div>
        <p id="vm-meaning" class="vm-vi">Meaning</p>
        <div class="vocab-modal-actions">
            <button id="vm-speak" class="btn-main" type="button">ğŸ”Š Nghe</button>
        </div>
        <p class="myword-empty">Nháº¥n â€œLÆ°u ngayâ€ bÃªn dÆ°á»›i Ä‘á»ƒ cho vÃ o sá»• tay nhÃ©!</p>
    </div>
</div>
<script>
    function playAudio(url) {
        return new Promise((resolve, reject) => {
            if (!url) {
                reject(new Error('URL khÃ´ng há»£p lá»‡'));
                return;
            }
            
            const audio = new Audio(url);
            
            audio.addEventListener('loadeddata', () => {
                audio.play().then(() => {
                    resolve();
                }).catch(err => {
                    console.error('Lá»—i phÃ¡t audio:', err);
                    reject(err);
                });
            });
            
            audio.addEventListener('error', (e) => {
                console.error('Lá»—i táº£i audio:', e);
                reject(new Error('KhÃ´ng thá»ƒ táº£i file audio. Kiá»ƒm tra Python service cÃ³ Ä‘ang cháº¡y khÃ´ng.'));
            });
            
            // Timeout sau 5 giÃ¢y
            setTimeout(() => {
                if (audio.readyState < 2) {
                    reject(new Error('Timeout khi táº£i audio'));
                }
            }, 5000);
        });
    }

    // Fallback sá»­ dá»¥ng Web Speech API
    function speakWithWebSpeech(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            speechSynthesis.speak(utterance);
            return true;
        }
        return false;
    }

    // Function Ä‘á»ƒ phÃ¡t audio tá»« button (cho AI suggestion)
    async function playAudioFromButton(button) {
        const audioUrl = button.getAttribute('data-audio-url');
        if (!audioUrl) {
            alert('KhÃ´ng cÃ³ URL audio!');
            return;
        }
        
        // Disable button while playing
        button.disabled = true;
        button.textContent = 'â³ Äang táº£i...';
        
        try {
            await playAudio(audioUrl);
        } catch (error) {
            console.error('Lá»—i phÃ¡t audio:', error);
            // Láº¥y text tá»« cÃ¢u suggestion Ä‘á»ƒ dÃ¹ng fallback
            const suggestionText = button.closest('.ai-result-block')?.querySelector('.ai-result span')?.textContent?.trim();
            if (suggestionText) {
                if (!speakWithWebSpeech(suggestionText)) {
                    alert('KhÃ´ng thá»ƒ phÃ¡t Ã¢m. Vui lÃ²ng kiá»ƒm tra Python service cÃ³ Ä‘ang cháº¡y khÃ´ng (http://localhost:8000)');
                }
            } else {
                alert('KhÃ´ng thá»ƒ phÃ¡t audio. Lá»—i: ' + error.message);
            }
        } finally {
            button.disabled = false;
            button.textContent = 'ğŸ”Š Nghe';
        }
    }

    async function speakText(text) {
        if (!text || text.trim() === '') {
            alert("KhÃ´ng cÃ³ vÄƒn báº£n Ä‘á»ƒ phÃ¡t Ã¢m!");
            return;
        }
        
        try {
            const res = await fetch(`/tts?text=${encodeURIComponent(text)}`);
            
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            
            const data = await res.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            if (data.audioUrl) {
                try {
                    await playAudio(data.audioUrl);
                } catch (audioError) {
                    console.warn('KhÃ´ng thá»ƒ phÃ¡t audio tá»« server, thá»­ dÃ¹ng Web Speech API:', audioError);
                    // Fallback to Web Speech API
                    if (!speakWithWebSpeech(text)) {
                        alert("KhÃ´ng thá»ƒ phÃ¡t Ã¢m. Vui lÃ²ng kiá»ƒm tra:\n1. Python service cÃ³ Ä‘ang cháº¡y khÃ´ng (http://localhost:8000)\n2. TrÃ¬nh duyá»‡t cÃ³ há»— trá»£ phÃ¡t audio khÃ´ng");
                    }
                }
            } else {
                throw new Error('KhÃ´ng nháº­n Ä‘Æ°á»£c URL audio tá»« server');
            }
        } catch (error) {
            console.error('Lá»—i khi gá»i TTS:', error);
            // Fallback to Web Speech API
            if (!speakWithWebSpeech(text)) {
                alert("KhÃ´ng táº¡o Ä‘Æ°á»£c audio tá»« server. Lá»—i: " + error.message + "\n\nVui lÃ²ng kiá»ƒm tra Python service cÃ³ Ä‘ang cháº¡y khÃ´ng (http://localhost:8000)");
            }
        }
    }

    const vocabItems = document.querySelectorAll('.lesson-content li');
    vocabItems.forEach(item => {
        item.style.cursor = 'pointer';
        item.addEventListener('click', () => {
            const text = item.innerText || '';
            const parts = text.split('â€“');
            const english = parts[0].trim();
            const vietnamese = parts[1] ? parts[1].trim() : '';
            document.getElementById('vm-word').innerText = english;
            document.getElementById('vm-meaning').innerText = vietnamese || 'Äang cáº­p nháº­t nghÄ©a.';
            document.getElementById('lessonWordEn').value = english;
            if (vietnamese) {
                document.getElementById('lessonWordVi').value = vietnamese;
            }
            document.getElementById('vocabModal').classList.remove('hidden');
        });
    });

    document.getElementById('vm-close').addEventListener('click', () => {
        document.getElementById('vocabModal').classList.add('hidden');
    });

    document.getElementById('vm-speak').addEventListener('click', () => {
        const word = document.getElementById('vm-word').innerText;
        speakText(word);
    });

    // Parse and display vocabulary cards with chibi style
    function parseAndDisplayVocabCards() {
        const lessonContent = document.querySelector('.lesson-content');
        if (!lessonContent) return;

        const vocabContainer = document.getElementById('vocabCardsContainer');
        if (!vocabContainer) return;

        // Find all list items with vocabulary
        const listItems = lessonContent.querySelectorAll('li');
        if (listItems.length === 0) {
            // If no list items, try to parse from content directly
            const content = lessonContent.innerHTML;
            if (content.includes('<ul>') || content.includes('<li>')) {
                // Content already has structure, show it
                vocabContainer.innerHTML = lessonContent.innerHTML;
                return;
            }
        }

        // Vocabulary to emoji/chibi mapping
        const vocabEmojiMap = {
            'doctor': 'ğŸ‘¨â€âš•ï¸', 'dentist': 'ğŸ‘¨â€âš•ï¸', 'tailor': 'ğŸ‘¨â€ğŸ’¼', 'teacher': 'ğŸ‘©â€ğŸ«', 
            'singer': 'ğŸ‘©â€ğŸ¤', 'artist': 'ğŸ‘¨â€ğŸ¨', 'nurse': 'ğŸ‘©â€âš•ï¸', 'chef': 'ğŸ‘¨â€ğŸ³',
            'pilot': 'ğŸ‘¨â€âœˆï¸', 'farmer': 'ğŸ‘¨â€ğŸŒ¾', 'police': 'ğŸ‘®', 'firefighter': 'ğŸ‘¨â€ğŸš’',
            'cat': 'ğŸ±', 'dog': 'ğŸ¶', 'bird': 'ğŸ¦', 'fish': 'ğŸŸ', 'rabbit': 'ğŸ°',
            'apple': 'ğŸ', 'banana': 'ğŸŒ', 'bread': 'ğŸ', 'milk': 'ğŸ¥›', 'egg': 'ğŸ¥š',
            'red': 'ğŸ”´', 'blue': 'ğŸ”µ', 'green': 'ğŸŸ¢', 'yellow': 'ğŸŸ¡', 'orange': 'ğŸŸ ',
            'father': 'ğŸ‘¨', 'mother': 'ğŸ‘©', 'brother': 'ğŸ‘¦', 'sister': 'ğŸ‘§', 'baby': 'ğŸ‘¶',
            'one': '1ï¸âƒ£', 'two': '2ï¸âƒ£', 'three': '3ï¸âƒ£', 'four': '4ï¸âƒ£', 'five': '5ï¸âƒ£',
            'book': 'ğŸ“–', 'pencil': 'âœï¸', 'school': 'ğŸ«', 'watch': 'âŒš', 'phone': 'ğŸ“±',
            'gift': 'ğŸ', 'suitcase': 'ğŸ§³', 'house': 'ğŸ ', 'car': 'ğŸš—', 'bike': 'ğŸš²'
        };

        vocabContainer.innerHTML = '<h3 style="margin-bottom: 20px; font-size: 24px; color: #1F2937;">ğŸ“š Tá»« vá»±ng</h3>';
        vocabContainer.innerHTML += '<div class="vocab-cards-grid"></div>';
        const grid = vocabContainer.querySelector('.vocab-cards-grid');

        listItems.forEach(item => {
            const text = item.textContent || item.innerText;
            const parts = text.split('â€“').map(p => p.trim());
            const english = parts[0] || '';
            const vietnamese = parts[1] || '';

            if (!english) return;

            // Get emoji for the word
            const wordLower = english.toLowerCase().replace(/[^a-z]/g, '');
            let emoji = vocabEmojiMap[wordLower] || 'ğŸ“';

            // Create vocab card
            const card = document.createElement('div');
            card.className = 'vocab-chibi-card';
            card.onclick = () => {
                document.getElementById('vm-word').innerText = english;
                document.getElementById('vm-meaning').innerText = vietnamese || 'Äang cáº­p nháº­t nghÄ©a.';
                document.getElementById('lessonWordEn').value = english;
                if (vietnamese) {
                    document.getElementById('lessonWordVi').value = vietnamese;
                }
                document.getElementById('vocabModal').classList.remove('hidden');
            };

            card.innerHTML = `
                <div class="vocab-chibi-image">
                    <div class="chibi-emoji">${emoji}</div>
                </div>
                <div class="vocab-chibi-word">${english}</div>
                <div class="vocab-chibi-meaning">${vietnamese || ''}</div>
                <button class="vocab-chibi-sound" onclick="event.stopPropagation(); speakText('${english}');" title="Nghe phÃ¡t Ã¢m">
                    ğŸ”Š
                </button>
            `;

            grid.appendChild(card);
        });
    }

    // Run when page loads
    document.addEventListener('DOMContentLoaded', () => {
        parseAndDisplayVocabCards();
    });
</script>
<style>
/* Vocabulary Chibi Cards */
.vocab-cards-container {
    margin: 30px 0;
}

.vocab-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.vocab-chibi-card {
    background: #FFFFFF;
    border: 3px solid #E5E7EB;
    border-radius: 20px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: hidden;
}

.vocab-chibi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #58CC02, #4CAF50);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.vocab-chibi-card:hover {
    transform: translateY(-5px);
    border-color: #58CC02;
    box-shadow: 0 8px 24px rgba(88, 204, 2, 0.2);
}

.vocab-chibi-card:hover::before {
    transform: scaleX(1);
}

.vocab-chibi-image {
    width: 120px;
    height: 120px;
    margin: 0 auto 15px;
    background: linear-gradient(135deg, #F0FDF4 0%, #D1FAE5 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 4px solid #58CC02;
    box-shadow: 0 4px 12px rgba(88, 204, 2, 0.15);
    transition: all 0.3s ease;
}

.vocab-chibi-card:hover .vocab-chibi-image {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 6px 16px rgba(88, 204, 2, 0.25);
}

.chibi-emoji {
    font-size: 70px;
    line-height: 1;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.vocab-chibi-word {
    font-size: 20px;
    font-weight: 900;
    color: #1F2937;
    margin-bottom: 8px;
    text-transform: capitalize;
    letter-spacing: 0.5px;
}

.vocab-chibi-meaning {
    font-size: 14px;
    color: #6B7280;
    margin-bottom: 10px;
    min-height: 20px;
}

.vocab-chibi-sound {
    width: 40px;
    height: 40px;
    background: #58CC02;
    border: 2px solid #1F2937;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(88, 204, 2, 0.3);
}

.vocab-chibi-sound:hover {
    transform: scale(1.15);
    background: #4CAF50;
    box-shadow: 0 4px 12px rgba(88, 204, 2, 0.4);
}

.vocab-chibi-sound:active {
    transform: scale(0.95);
}

.hidden {
    display: none !important;
}

/* Responsive */
@media (max-width: 768px) {
    .vocab-cards-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }
    
    .vocab-chibi-image {
        width: 100px;
        height: 100px;
    }
    
    .chibi-emoji {
        font-size: 60px;
    }
    
    .vocab-chibi-word {
        font-size: 18px;
    }
}
</style>
</body>
</html>
