<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Game Luy·ªán t·∫≠p - Kid Nani</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <script src="/grade-dropdown.js" defer></script>
    <style>
        .practice-game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .game-header h1 {
            color: #1F2937;
            margin-bottom: 10px;
        }
        
        .game-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: #F3F4F6;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            color: #1F2937;
        }
        
        .game-area {
            background: linear-gradient(135deg, #E0F2FE 0%, #DBEAFE 100%);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            min-height: 500px;
        }
        
        .target-word {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .target-word-box {
            display: inline-block;
            background: white;
            padding: 20px 40px;
            border-radius: 16px;
            border: 3px solid #EF4444;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .target-word-box h2 {
            margin: 0;
            font-size: 32px;
            color: #1F2937;
            text-transform: lowercase;
        }
        
        .sound-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #EF4444;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            transition: transform 0.2s;
        }
        
        .sound-button:hover {
            transform: scale(1.1);
        }
        
        .images-container {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 40px;
        }
        
        .image-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .image-card.selected {
            border: 4px solid #10B981;
            transform: scale(1.05);
        }
        
        .image-card.correct {
            border: 4px solid #10B981;
            background: #D1FAE5;
        }
        
        .image-card.wrong {
            border: 4px solid #EF4444;
            background: #FEE2E2;
        }
        
        .emoji-large {
            font-size: 80px;
        }
        
        .game-feedback {
            text-align: center;
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            min-height: 40px;
        }
        
        .game-feedback.correct {
            color: #10B981;
        }
        
        .game-feedback.wrong {
            color: #EF4444;
        }
        
        .game-actions {
            text-align: center;
            margin-top: 30px;
        }
        
        .next-btn {
            background: #10B981;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }
        
        .next-btn.show {
            display: inline-block;
        }
        
        .next-btn:hover {
            background: #059669;
        }
        
        .monster {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 60px;
        }
    </style>
</head>
<body>
<div class="layout">
    <header class="top-nav">
        <div class="logo">duokid</div>
        <nav>
            <a th:href="@{/dashboard}">üè† H·ªåC</a>
            <span class="menu-divider"></span>
            <div class="grade-dropdown">
                <span class="grade-dropdown-trigger">üìö L·ªõp h·ªçc</span>
                <div class="grade-dropdown-menu">
                    <a th:href="@{/grade/GRADE1}">L·ªõp 1</a>
                    <a th:href="@{/grade/GRADE2}">L·ªõp 2</a>
                    <a th:href="@{/grade/GRADE3}">L·ªõp 3</a>
                    <a th:href="@{/grade/GRADE4}">L·ªõp 4</a>
                    <a th:href="@{/grade/GRADE5}">L·ªõp 5</a>
                </div>
            </div>
            <span class="menu-divider"></span>
            <a th:href="@{/mywords}">üìù S·ªï tay</a>
            <a th:href="@{/vocabulary}">üìö T·ª´ v·ª±ng</a>
            <a th:href="@{/practice}">üîÑ √în t·∫≠p</a>
            <a th:href="@{/minigame}">üéÆ Mini game</a>
            <a th:href="@{/leaderboard}">üèÜ B·∫£ng x·∫øp h·∫°ng</a>
            <a th:href="@{/shop}">üõí C·ª≠a h√†ng</a>
            <a th:href="@{/chat}">üí¨ Chat</a>
            <a th:href="@{/profile}">üë§ H·ªì s∆°</a>
            <span class="menu-divider"></span>
            <a th:href="@{/logout}">üö™ ƒêƒÉng xu·∫•t</a>
        </nav>
    </header>
    <main class="main">
        <div class="practice-game-container">
            <div class="game-header">
                <h1>üéÆ Game Luy·ªán t·∫≠p</h1>
                <p>Ch·ªçn h√¨nh ·∫£nh ƒë√∫ng v·ªõi t·ª´ v·ª±ng!</p>
            </div>
            
            <div class="game-stats">
                <div class="stat-box">
                    <span id="questionNumber">1</span>/<span id="totalQuestions">30</span>
                </div>
                <div class="stat-box">
                    ƒêi·ªÉm: <span id="score">0</span>
                </div>
            </div>
            
            <div class="game-area">
                <button class="sound-button" onclick="playWordSound()" title="Nghe ph√°t √¢m">
                    üîä
                </button>
                
                <div class="target-word">
                    <div class="target-word-box">
                        <h2 id="targetWord">watch</h2>
                    </div>
                </div>
                
                <div class="images-container" id="imagesContainer">
                    <!-- Images will be generated by JavaScript -->
                </div>
                
                <div class="game-feedback" id="feedback"></div>
                
                <div class="monster">üëæ</div>
            </div>
            
            <div class="game-actions">
                <button class="next-btn" id="nextBtn" onclick="nextQuestion()">C√¢u ti·∫øp theo ‚Üí</button>
            </div>
        </div>
    </main>
</div>

<script>
    // Game data
    const vocabData = [
        { word: "watch", emoji: "‚åö", category: "Personal" },
        { word: "phone", emoji: "üì±", category: "Personal" },
        { word: "zipper", emoji: "üîó", category: "Personal" },
        { word: "cat", emoji: "üê±", category: "Animals" },
        { word: "dog", emoji: "üê∂", category: "Animals" },
        { word: "bird", emoji: "üê¶", category: "Animals" },
        { word: "red", emoji: "üî¥", category: "Colors" },
        { word: "blue", emoji: "üîµ", category: "Colors" },
        { word: "green", emoji: "üü¢", category: "Colors" },
        { word: "apple", emoji: "üçé", category: "Food" },
        { word: "banana", emoji: "üçå", category: "Food" },
        { word: "bread", emoji: "üçû", category: "Food" },
        { word: "father", emoji: "üë®", category: "Family" },
        { word: "mother", emoji: "üë©", category: "Family" },
        { word: "brother", emoji: "üë¶", category: "Family" },
        { word: "one", emoji: "1Ô∏è‚É£", category: "Numbers" },
        { word: "two", emoji: "2Ô∏è‚É£", category: "Numbers" },
        { word: "three", emoji: "3Ô∏è‚É£", category: "Numbers" }
    ];
    
    let currentQuestion = 0;
    let score = 0;
    let currentCorrectWord = null;
    let selectedCard = null;
    let gameData = [];
    
    // Initialize game
    document.addEventListener('DOMContentLoaded', function() {
        shuffleArray(vocabData);
        gameData = vocabData.slice(0, 30);
        loadQuestion();
    });
    
    function loadQuestion() {
        if (currentQuestion >= gameData.length) {
            endGame();
            return;
        }
        
        const question = gameData[currentQuestion];
        currentCorrectWord = question.word;
        
        // Update question number
        document.getElementById('questionNumber').textContent = currentQuestion + 1;
        document.getElementById('totalQuestions').textContent = gameData.length;
        
        // Update target word
        document.getElementById('targetWord').textContent = question.word;
        
        // Generate 3 random images (1 correct + 2 wrong)
        const wrongWords = vocabData.filter(v => v.word !== question.word);
        shuffleArray(wrongWords);
        const options = [
            question,
            wrongWords[0],
            wrongWords[1]
        ];
        shuffleArray(options);
        
        // Clear and populate images
        const container = document.getElementById('imagesContainer');
        container.innerHTML = '';
        
        options.forEach((option, index) => {
            const card = document.createElement('div');
            card.className = 'image-card';
            card.dataset.word = option.word;
            card.onclick = () => selectCard(card, option.word);
            
            const emoji = document.createElement('div');
            emoji.className = 'emoji-large';
            emoji.textContent = option.emoji;
            
            card.appendChild(emoji);
            container.appendChild(card);
        });
        
        // Reset UI
        document.getElementById('feedback').textContent = '';
        document.getElementById('feedback').className = 'game-feedback';
        document.getElementById('nextBtn').classList.remove('show');
        selectedCard = null;
    }
    
    function selectCard(card, word) {
        if (selectedCard) return; // Already answered
        
        selectedCard = card;
        
        // Remove previous selections
        document.querySelectorAll('.image-card').forEach(c => {
            c.classList.remove('selected');
        });
        
        card.classList.add('selected');
        
        // Check answer
        if (word === currentCorrectWord) {
            card.classList.add('correct');
            score++;
            document.getElementById('score').textContent = score;
            document.getElementById('feedback').textContent = '‚úì ƒê√∫ng r·ªìi! Tuy·ªát v·ªùi!';
            document.getElementById('feedback').className = 'game-feedback correct';
        } else {
            card.classList.add('wrong');
            // Highlight correct answer
            document.querySelectorAll('.image-card').forEach(c => {
                if (c.dataset.word === currentCorrectWord) {
                    c.classList.add('correct');
                }
            });
            document.getElementById('feedback').textContent = '‚úó Ch∆∞a ƒë√∫ng. H√£y th·ª≠ l·∫°i!';
            document.getElementById('feedback').className = 'game-feedback wrong';
        }
        
        // Show next button
        document.getElementById('nextBtn').classList.add('show');
    }
    
    function nextQuestion() {
        currentQuestion++;
        loadQuestion();
    }
    
    function playWordSound() {
        const word = document.getElementById('targetWord').textContent;
        fetch(`/tts?text=${encodeURIComponent(word)}`)
            .then(res => res.json())
            .then(data => {
                if (data.audioUrl) {
                    const audio = new Audio(data.audioUrl);
                    audio.play().catch(err => {
                        console.error('Error playing audio:', err);
                        // Fallback to Web Speech API
                        if ('speechSynthesis' in window) {
                            const utterance = new SpeechSynthesisUtterance(word);
                            utterance.lang = 'en-US';
                            speechSynthesis.speak(utterance);
                        }
                    });
                }
            })
            .catch(err => {
                console.error('Error fetching audio:', err);
                // Fallback to Web Speech API
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'en-US';
                    speechSynthesis.speak(utterance);
                }
            });
    }
    
    function endGame() {
        const percentage = Math.round((score / gameData.length) * 100);
        document.getElementById('imagesContainer').innerHTML = `
            <div style="text-align: center; width: 100%;">
                <h2 style="font-size: 48px; margin-bottom: 20px;">üéâ Ho√†n th√†nh!</h2>
                <p style="font-size: 24px; margin-bottom: 10px;">ƒêi·ªÉm s·ªë: ${score}/${gameData.length}</p>
                <p style="font-size: 20px; color: #6B7280;">T·ª∑ l·ªá ƒë√∫ng: ${percentage}%</p>
                <div style="margin-top: 30px;">
                    <a href="/practice" class="btn-main" style="display: inline-block; margin-right: 10px;">Quay l·∫°i √¥n t·∫≠p</a>
                    <button class="btn-main" onclick="location.reload()" style="background: #10B981;">Ch∆°i l·∫°i</button>
                </div>
            </div>
        `;
        document.getElementById('targetWord').textContent = '';
        document.getElementById('nextBtn').style.display = 'none';
    }
    
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
</script>
</body>
</html>

